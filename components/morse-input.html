<!-- -*- mode: html; indent-tabs-mode: nil; -*- -->
<html>
  <head>
    <link rel="import" href="../bower_components/core-menu/core-menu.html">
    <link rel="import" href="../bower_components/core-icons/core-icons.html">
    <link rel="import" href="../bower_components/core-tooltip/core-tooltip.html">
    <link rel="import" href="../bower_components/paper-button/paper-button.html">
    <link rel="import" href="../bower_components/paper-dropdown/paper-dropdown.html">
    <link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
    <link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="../bower_components/paper-input/paper-autogrow-textarea.html">
    <link rel="import" href="../bower_components/paper-input/paper-input.html">
    <link rel="import" href="../bower_components/paper-item/paper-item.html">
    <link rel="import" href="../bower_components/paper-progress/paper-progress.html">
    <link rel="import" href="../bower_components/paper-slider/paper-slider.html">
    <link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
    <link rel="import" href="morse-station.html">
  </head>
  <body>
    <polymer-element name="morse-input">
      <template>
	<style>    
	  :host {
	    position: absolute;
	    width: 100%;
	    height: 100%;
	    box-sizing: border-box;
	  }
	  section {
	    margin: 20px;
	  }
	  .key {
	    margin: 12px;
	    font-size: 35px;
	    font-weight: bold;
	  }
	</style>
	<section>
	  <morse-station id="station"
			 input_pitch="{{input_pitch}}" input_gain_dB="{{input_gain_dB}}" input_wpm="{{input_wpm}}"
			 input_rise_ms="{{input_rise_ms}}" input_fall_ms="{{input_fall_ms}}" input_dah="{{input_dah}}"
			 input_ies="{{input_ies}}" input_ils="{{input_ils}}" input_iws="{{input_iws}}"
			 input_midi="{{input_midi}}" input_swapped="{{input_swapped}}" input_type="{{input_type}}"></morse-station>
	  <div layout vertical block>
	    <div layout horizontal block top>
	      <paper-autogrow-textarea rows="4" maxrows="10">
		<textarea readonly>{{decoded_text}}</textarea>
	      </paper-autogrow-textarea>
	      <core-tooltip label="clear text area">
                <paper-icon-button icon="clear" on-click="{{clear_textarea}}"></paper-icon-button>
              </core-tooltip>
	    </div>
	    <div layout horizontal block center>
	      <paper-button class="key" raised
			    on-touchstart="{{left_touchstart}}" on-touchend="{{left_touchend}}"
			    on-mousedown="{{left_mousedown}}" on-mouseup="{{left_mouseup}}"
			    oncontextmenu="return false"
			    >&lt;</paper-button>
	      <paper-button class="key" raised
			    on-touchstart="{{right_touchstart}}" on-touchend="{{right_touchend}}"
			    on-mousedown="{{right_mousedown}}" on-mouseup="{{right_mouseup}}"
			    oncontextmenu="return false"
			    >&gt;</paper-button>
	    </div>
	    <div horizontal layout block center>
	      <h2>Settings</h2>
	    </div>
	    <div layout horizontal block center>
	      <paper-dropdown-menu>
		<paper-dropdown class="dropdown">
		  <core-menu class="menu" valueattr="label" selected="{{input_type}}">
		    <paper-item label="straight">Straight Key</paper-item>
		    <paper-item label="iambic">Iambic Paddle</paper-item>
		  </core-menu>
		</paper-dropdown>
	      </paper-dropdown-menu>Key Type
	    </div>
	    <div layout horizontal block center>
	      <paper-slider value="{{input_pitch}}" min="220" max="1760" pin="true" snap="true"></paper-slider>
	      <core-tooltip label="sidetone frequency">Pitch <span>{{input_pitch}}</span> Hz</core-tooltip>
	    </div>
	    <div layout horizontal block center>
	      <paper-slider value="{{input_gain_dB}}" min="-60" max="0" pin="true" snap="true"></paper-slider>
	      <core-tooltip label="sidetone level">Gain <span>{{input_gain_dB}}</span> dB</core-tooltip>
	    </div>
	    <div layout horizontal block center>
              <paper-slider value="{{input_rise_ms}}" min="1" max="10" pin="true" snap="true"></paper-slider>
	      <core-tooltip label="envelope rise time">Rise <span>{{input_rise_ms}}</span> ms</core-tooltip>
	    </div>
	    <div layout horizontal block center>
	      <paper-slider value="{{input_fall_ms}}" min="1" max="10" pin="true" snap="true"></paper-slider>
	      <core-tooltip label="envelope fall time">Fall <span>{{input_fall_ms}}</span> ms</core-tooltip>
	    </div>
	    <div layout horizontal block center>
	      <paper-slider iambic value="{{input_wpm}}" min="5" max="50" step="2.5" pin="true" snap="true"></paper-slider>
	      <core-tooltip label="key speed">Speed <span>{{input_wpm}}</span> wpm</core-tooltip>
	    </div>
	    <div layout horizontal block center>
	      <paper-slider iambic value="{{input_dah}}" min="2.5" max="3.5" step="0.1" pin="true" snap="true"></paper-slider>
	      <core-tooltip label="dash length">Dah <span>{{input_dah}}</span> dits</core-tooltip>
	    </div>
	    <div layout horizontal block center>
	      <paper-slider iambic value="{{input_ies}}" min="0.75" max="1.25" step="0.05" pin="true" snap="true"></paper-slider>
	      <core-tooltip label="inter-element space length">IES <span>{{input_ies}}</span> dits</core-tooltip>
	    </div>
	    <div layout horizontal block center>
	      <paper-slider iambic value="{{input_ils}}" min="2.5" max="3.5" step="0.1" pin="true" snap="true"></paper-slider>
	      <core-tooltip label="inter-letter space length">ILS <span>{{input_ils}}</span> dits</core-tooltip>
	    </div>
	    <div layout horizontal block center>
	      <paper-slider iambic value="{{input_iws}}" min="6.5" max="7.5" step="0.1" pin="true" snap="true"></paper-slider>
	      <core-tooltip label="inter-word space length.">IWS <span>{{input_iws}}</span> dits</core-tooltip>
	    </div>
	    <div layout horizontal block center>
	      <paper-toggle-button iambic label="Swap Paddles" checked="{{input_swapped}}"></paper-toggle-button>Swap Paddles
	    </div>
	    <div layout horizontal block center>
	      <paper-dropdown-menu label="MIDI Device">
		<paper-dropdown class="dropdown">
		  <core-menu class="menu" valueattr="label" selected="{{input_midi}}">
		    <paper-item label="none">None</paper-item>
		  </core-menu>
		</paper-dropdown>
	      </paper-dropdown-menu>
	      <core-tooltip label="Reload the MIDI device list.">
		<paper-icon-button id="input_midi_reload" icon="refresh"></paper-icon-button>
	      </core-tooltip>MIDI Device
	    </div>
	  </div>
	</section>
      </template>
      <script>
    Polymer({
	publish : {
	    // shared with morse-station and local controls
            input_pitch : 600,
            input_gain_dB : -26,
            input_wpm : 15,
            input_rise_ms : 4,
            input_fall_ms : 4,
            input_dah : 3,
            input_ies : 1,
            input_ils : 3,
            input_iws : 7,
            input_midi : "none",
            input_swapped : false,
            input_type : 'iambic',
	    // shared with local textarea
	    decoded_text : ""
	},

	ready : function() { this.$.station.input_decoder_on_letter(this.onletter, this); },

	input_midi_refresh : function() { this.$.station.input_midi_refresh(); },
	input_midi_names : function() { return this.$.station.input_midi_names(); },

	// input_pitchChanged : function(oldv, newv) { this.attrChanged('input_pitch', oldv, newv); },
	// input_gain_dBChanged : function(oldv, newv) { this.attrChanged('input_gain_dB', oldv, newv); },
	// input_wpmChanged : function(oldv, newv) { this.attrChanged('input_wpm', oldv, newv); },
	// input_rise_msChanged : function(oldv, newv) { this.attrChanged('input_rise_ms', oldv, newv); },
	// input_fall_msChanged : function(oldv, newv) { this.attrChanged('input_fall_ms', oldv, newv); },
	// input_dahChanged : function(oldv, newv) { this.attrChanged('input_dah', oldv, newv); },
	// input_iesChanged : function(oldv, newv) { this.attrChanged('input_ies', oldv, newv); },
	// input_ilsChanged : function(oldv, newv) { this.attrChanged('input_ils', oldv, newv); },
	// input_iwsChanged : function(oldv, newv) { this.attrChanged('input_iws', oldv, newv); },
	// input_midiChanged : function(oldv, newv) { this.attrChanged('input_midi', oldv, newv); },
	// input_swappedChanged : function(oldv, newv) { this.attrChanged('input_swapped', oldv, newv); },
	input_typeChanged : function(oldv, newv) {
	    var disabled = newv != 'iambic';
	    var elts = this.shadowRoot.querySelectorAll("[iambic]");
	    for (var i = 0; i < elts.length; i += 1) elts[i].disabled = disabled;
	    // this.attrChanged('input_type', oldv, newv);
	},

	// attrChanged : function(attr, oldv, newv) { console.log("input:"+attr, "oldv="+oldv, "newv="+newv); },

	onletter : function(letter, code) { this.decoded_text += letter; },

	clear_textarea : function(event, detail, sender) { this.decoded_text = ""; },

	// key event handlers with backed in reference to this
	keydownhandler : null,
	keyuphandler : null,
	keyhandlers : function() {
            if ( ! this.keydownhandler)
		this.keydownhandler = (function(self) {
                    return function(e) { self.keydown(e); }
		})(this);
            if ( ! this.keyuphandler)
		this.keyuphandler = (function(self) {
                    return function(e) { self.keyup(e); }
		})(this);
	},

	onblur : function() {
            // console.log('morse-input blur');
            this.keyhandlers();
            this.removeEventListener('keydown', this.keydownhandler);
            this.removeEventListener('keyup', this.keyuphandler);
            this.$.station.input_blur();
            this.blur();
	    var tbd = document.getElementById('title_bar_div');
	    if (tbd) tbd.innerText = "Morse Code";
	},
	onfocus : function() {
            // console.log('morse-input focus');
            this.keyhandlers();
            this.addEventListener('keydown', this.keydownhandler);
            this.addEventListener('keyup', this.keyuphandler);
            this.$.station.input_focus();
            this.focus();
	    var tbd = document.querySelector('#title_bar_div');
	    console.log("title_bar_div", tbd);
	    if (tbd) tbd.innerText = "Morse Code > Input";
	},

	keydown : function(e) { this.$.station.input_keydown((e.keyCode&1)^1); },
	keyup : function(e) { this.$.station.input_keyup((e.keyCode&1)^1); },

	left_touchstart : function(e) { this.$.station.input_keydown(1); },
	left_touchend : function(e) { this.$.station.input_keyup(1); },
	right_touchstart : function(e) { this.$.station.input_keydown(0); },
	right_touchend : function(e) { this.$.station.input_keyup(0);  },
        
	left_mousedown : function(e) { this.$.station.input_keydown((e.button==0 ? 0 : 1) ^ 1); },
	left_mouseup : function(e) {  this.$.station.input_keyup((e.button==0 ? 0 : 1) ^ 1); },
	right_mousedown : function(e) { this.$.station.input_keydown((e.button==0 ? 0 : 1) ^ 0); },
	right_mouseup : function(e) {  this.$.station.input_keyup((e.button==0 ? 0 : 1) ^ 0); },
        
    });
      </script>
    </polymer-element>
  </body>
</html>
